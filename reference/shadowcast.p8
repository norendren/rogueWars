pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
--rog
--by 

--Utils
-- globals

-- lookup
keydir={
  [0]={x=-1,y=0},[1]={x=1,y=0},[2]={x=0,y=-1},[3]={x=0,y=1}
}

walls={}
visible={}


player={x=4,y=4,s=3,light=7}
orc={x=8,y=3,s=5}

function set_wall(x,y,w)
  walls[x..","..y]=w
end

function move_wall(ax,ay,bx,by)
  local ak,bk=ax..","..ay,bx..","..by
  local tmp=walls[ak]
  walls[ak]=walls[bk]
  walls[bk]=tmp
end
function move_entity(e,x,y)
  local k=x..","..y
  local w=walls[k]
  if w then
    if w==0 then
      move_wall(e.x,e.y,x,y)
      e.x,e.y=x,y
    else
      --bump?
    end
  end
end


-- method is a function(c,r)
function forinrect(x,y,w,h,method)
  for c=x,(x+w)-1 do
    for r=y,(y+h)-1 do
      method(c,r)
    end
  end
end

-- recursive shadow casting
-- adapted from https://www.lexaloffle.com/bbs/?pid=28780 by cheepicus

function do_fov(x,y,r)
  visible={[x..","..y]=true}
  local p={x=x,y=y}
  for oct=0,7 do
   fov(p,1,0,1,oct,r)
  end
end

function fov(p,d,lo_slp,hi_slp,oct,r)
  -- distance, height from player
  -- to map xy
  -- flips/transposes per octant
  function dhtoxy(d,h)
   local x,y=p.x,p.y
   if band(oct,0x1)>0 then d=-d end
   if band(oct,0x2)>0 then h=-h end
   if band(oct,0x4)>0 then 
    return x+h,y+d
   end
   return x+d,y+h
  end

  if d>r then
   return
  end
  local mapx,mapy,lo,hi
  local in_gap
  lo=flr(lo_slp*d+0.5)
  hi=flr(hi_slp*d+0.5)

  for h=lo,hi do
   mapx,mapy=dhtoxy(d,h)
   if dist_to(p.x,p.y,mapx,mapy)<r then
     visible[mapx..","..mapy]=true  
   end
   
   if is_opaque(mapx,mapy) then
    if in_gap then
     -- reached end of gap
     fov(p,d+1,lo_slp,(h-0.5)/d,oct,r)
    end
    lo_slp=(h+0.5)/d
    in_gap=false
   else
    in_gap=true
    if h==hi then
     -- end of gap
     fov(p,d+1,lo_slp,hi_slp,oct,r)
    end
   end
  end
end

--returns 0 at high distances due to overflow
function dist_to(ax,ay,bx,by)
  local vx,vy=ax-bx,ay-by
  return sqrt(vx*vx+vy*vy)
end

function is_opaque(x,y)
  local w=walls[x..","..y]
  if w==0 then return false end
  return true
end

--Game
function _init()
		local brush=0
  local function fill(x,y)
    walls[x..","..y]=brush
  end
  forinrect(1,1,14,14,fill)
  
  set_wall(5,5,nil)
  set_wall(3,9,nil)
  brush=nil
  forinrect(8,6,3,3,fill)
  forinrect(2,11,3,1,fill)
  forinrect(6,11,3,1,fill)
  set_wall(player.x,player.y,player)
  set_wall(orc.x,orc.y,orc)
  
  do_fov(player.x,player.y,player.light)
end

function _update()
  local bp=-1
  if(btnp(0)) bp=0
  if(btnp(1)) bp=1
  if(btnp(2)) bp=2
  if(btnp(3)) bp=3
  
  if bp>=0 then
    local d=keydir[bp]
    move_entity(player,player.x+d.x,player.y+d.y)
    do_fov(player.x,player.y,player.light)
  end
  
end

function _draw()
  cls()
  forinrect(0,0,16,16,draw_at)
end

function draw_at(x,y,tbl)
  tbl=tbl or walls
  local k=x..","..y
  if not visible[k] then return end
  local w=tbl[k]
  if w then
    if w==0 then
      spr(1,x*8,y*8)
    elseif w.s then
      spr(w.s,x*8,y*8)
    else
      spr(2,x*8,y*8)
    end
  else
    spr(2,x*8,y*8)
  end
end
    

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000050050000555555005555550077777700bbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000500555555005555550077777700bbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000500000555555005c55c50070770700b2bb2b000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000050000000555555005f55f50067667600bbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070000005000055555500995599000066000033bb33000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000050000500555555009999990000770000333333000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550055555500555555005555550055555500555555005555550055555500555555005555550000000000000000000000000000000000000000000000000
05555550055555500555555005555550055555500555555005555550055555500555555005555550000000000000000000000000000000000000000000000000
05555550055555500555555005555550055555500555555005555550055555500555555005555550000000000000000000000000000000000000000000000000
05555550055555500555555005555550055555500555555005555550055555500555555005555550000000000000000000000000000000000000000000000000
05555550055555500555555005555550055555500555555005555550055555500555555005555550000000000000000000000000000000000000000000000000
05555550055555500555555005555550055555500555555005555550055555500555555005555550000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550050050000500500005005000050050000500500005005000050050000500500005005000050050000000000000000000000000000000000000000000
05555550000000500000005000000050000000500000005000000050000000500000005000000050000000500000000000000000000000000000000000000000
05555550000500000005000000050000000500000005000000050000000500000005000000050000000500000000000000000000000000000000000000000000
05555550050000000500000005000000050000000500000005000000050000000500000005000000050000000000000000000000000000000000000000000000
05555550000050000000500000005000000050000000500000005000000050000000500000005000000050000000000000000000000000000000000000000000
05555550050000500500005005000050050000500500005005000050050000500500005005000050050000500000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550050050000500500005005000050050000500500005005000050050000500500005005000050050000000000000000000000000000000000000000000
05555550000000500000005000000050000000500000005000000050000000500000005000000050000000500000000000000000000000000000000000000000
05555550000500000005000000050000000500000005000000050000000500000005000000050000000500000000000000000000000000000000000000000000
05555550050000000500000005000000050000000500000005000000050000000500000005000000050000000000000000000000000000000000000000000000
05555550000050000000500000005000000050000000500000005000000050000000500000005000000050000000000000000000000000000000000000000000
05555550050000500500005005000050050000500500005005000050050000500500005005000050050000500000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550050050000500500005005000050050000500500005005000050050000bbbbbb005005000050050000000000000000000000000000000000000000000
05555550000000500000005000000050000000500000005000000050000000500bbbbbb000000050000000500000000000000000000000000000000000000000
05555550000500000005000000050000000500000005000000050000000500000b2bb2b000050000000500000000000000000000000000000000000000000000
05555550050000000500000005000000050000000500000005000000050000000bbbbbb005000000050000000000000000000000000000000000000000000000
0555555000005000000050000000500000005000000050000000500000005000033bb33000005000000050000000000000000000000000000000000000000000
05555550050000500500005005000050050000500500005005000050050000500333333005000050050000500000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550050050000500500005005000055555500500500005005000050050000500500005005000050050000000000000000000000000000000000000000000
05555550000000500000005000000050055555500000005000000050000000500000005000000050000000500000000000000000000000000000000000000000
0555555000050000000500000005000005c55c500005000000050000000500000005000000050000000500000000000000000000000000000000000000000000
0555555005000000050000000500000005f55f500500000005000000050000000500000005000000050000000000000000000000000000000000000000000000
05555550000050000000500000005000099559900000500000005000000050000000500000005000000050000000000000000000000000000000000000000000
05555550050000500500005005000050099999900500005005000050050000500500005005000050050000500000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550050050000500500005005000050050000555555005005000050050000500500005005000050050000000000000000000000000000000000000000000
05555550000000500000005000000050000000500555555000000050000000500000005000000050000000500000000000000000000000000000000000000000
05555550000500000005000000050000000500000555555000050000000500000005000000050000000500000000000000000000000000000000000000000000
05555550050000000500000005000000050000000555555005000000050000000500000005000000050000000000000000000000000000000000000000000000
05555550000050000000500000005000000050000555555000005000000050000000500000005000000050000000000000000000000000000000000000000000
05555550050000500500005005000050050000500555555005000050050000500500005005000050050000500000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550050050000500500005005000050050000500500000000000050050000555555005555550055555500000000000000000000000000000000000000000
05555550000000500000005000000050000000500000005000000000000000500555555005555550055555500000000000000000000000000000000000000000
05555550000500000005000000050000000500000005000000000000000500000555555005555550055555500000000000000000000000000000000000000000
05555550050000000500000005000000050000000500000000000000050000000555555005555550055555500000000000000000000000000000000000000000
05555550000050000000500000005000000050000000500000000000000050000555555005555550055555500000000000000000000000000000000000000000
05555550050000500500005005000050050000500500005000000000050000500555555005555550055555500000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550050050000500500005005000050050000500500005005000000000000000000000000000000000000000000000000000000000000000000000000000
05555550000000500000005000000050000000500000005000000050000000000000000000000000000000000000000000000000000000000000000000000000
05555550000500000005000000050000000500000005000000050000000000000000000000000000000000000000000000000000000000000000000000000000
05555550050000000500000005000000050000000500000005000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550000050000000500000005000000050000000500000005000000000000000000000000000000000000000000000000000000000000000000000000000
05555550050000500500005005000050050000500500005005000050000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550050050000500500005005000050050000500500005005000000000000000000000000000000000000000000000000000000000000000000000000000
05555550000000500000005000000050000000500000005000000050000000000000000000000000000000000000000000000000000000000000000000000000
05555550000500000005000000050000000500000005000000050000000000000000000000000000000000000000000000000000000000000000000000000000
05555550050000000500000005000000050000000500000005000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550000050000000500000005000000050000000500000005000000000000000000000000000000000000000000000000000000000000000000000000000
05555550050000500500005005000050050000500500005005000050000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555550050050000500500005555550050050000500500005005000050050000000000000000000000000000000000000000000000000000000000000000000
05555550000000500000005005555550000000500000005000000050000000500000000000000000000000000000000000000000000000000000000000000000
05555550000500000005000005555550000500000005000000050000000500000000000000000000000000000000000000000000000000000000000000000000
05555550050000000500000005555550050000000500000005000000050000000000000000000000000000000000000000000000000000000000000000000000
05555550000050000000500005555550000050000000500000005000000050000000000000000000000000000000000000000000000000000000000000000000
05555550050000500500005005555550050000500500005005000050050000500000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000050050000500500005005000050050000500500005005000050050000000000000000000000000000000000000000000000000000000000000000000
00000000000000500000005000000050000000500000005000000050000000500000000000000000000000000000000000000000000000000000000000000000
0000000000050000000500000005000000050000000500000005000000050000000000000000000000000000000000000f000000000000000f00000000000000
000000000500000005000000050000000500000005000000050000000500000000f00000f000000000000f000000000000000000000000000000000000000000
0000000000005000000050000000500f000050000000500000005000000050000000000000000000000000000000000000f00000000000000000000000000000
00000000050000500500005005000050050000500500005005000f50050000500000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000f000000000000000000000000000000000000000f0f0000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

__gff__
0000010204040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
